<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="">

    <link rel="icon" type="image/png" href="/public/favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
    <style>
      #map { height: 400px; }
    </style>

    <title>A Title</title>

    </head>

    <body>
        <section id="app"></section>
        <section id="map"></section>
        <script type="module">
            // https://rustwasm.github.io/docs/wasm-bindgen/examples/without-a-bundler.html
            import init from '/pkg/package.js';
            import { start, BBox } from '/pkg/package.js';
            console.log("init wasm");
            init('/pkg/package_bg.wasm').then((res,err) => {
              const [marker_clicked, update_bbox] = start();
              window.marker_clicked = marker_clicked;
              window.update_bbox = update_bbox;
              updateBbox();
            });
            window.BBox = BBox;
        </script>
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
   integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
   crossorigin=""></script>
    <script>
      var token = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
      var map = L.map('map').setView([48.0, 8.0],8)
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox.streets',
          accessToken: token
        }).addTo(map);

      var markers = L.layerGroup();

      markers.addTo(map);

      var setMapCenter = (lat, lng) => {
        console.log("JS: got ev", lat, lng);
        map.setView([lat, lng],8);
        updateBbox();
      };

      var updateBbox = () => {
        let bounds = map.getBounds();
        let ne = bounds.getNorthEast();
        let sw = bounds.getSouthWest();
        update_bbox(new BBox(sw.lat, sw.lng, ne.lat, ne.lng));
      };

      var updateMap = (entries) => {
        console.log("Got entries", entries);
        markers.clearLayers();
        entries
          //.map(e => L.marker([e.lat, e.lng]))
          .forEach(e => {
            let m = L.marker([e.lat, e.lng]);
            m.bindPopup(e.title);
            m.on('click',()=>{marker_clicked(e.id);})
            m.addTo(markers);
          });
      };
      map.on('moveend',updateBbox);
      map.on('zoomend',updateBbox);
      window.updateBbox = updateBbox;
    </script>
    </body>

</html>
